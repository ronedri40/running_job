import httpx
import logging

logger = logging.getLogger(__name__)

class HttpEngine:
    def __init__(self, client: httpx.AsyncClient):
        self.client = client

    async def process_batch(self, url: str, payload: dict, timeout: int) -> dict:
        job_id = payload.get("job_id")
        batch_idx = payload.get("batch_index", "?")
        
        logger.debug(f"[{job_id}] Sending batch {batch_idx} to {url}")
        
        try:
            response = await self.client.post(
                f"{url.rstrip('/')}/run_batch", 
                json=payload, 
                timeout=timeout
            )
            response.raise_for_status()
            logger.debug(f"[{job_id}] Batch {batch_idx} success (Status: {response.status_code})")
            return response.json()
        except httpx.HTTPError as e:
            logger.warning(f"[{job_id}] Batch {batch_idx} failed: {str(e)}")
            raise
