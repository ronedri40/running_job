import uuid
from collections import deque
from .dispatcher import JobContext, Dispatcher

class JobRunner:
    def __init__(self, dispatcher: Dispatcher):
        self.dispatcher = dispatcher

    async def submit_job(self, agent_name: str, items: list, params: dict, callbacks: object) -> str:
        if agent_name not in self.dispatcher.configs:
            raise ValueError(f"Agent '{agent_name}' is not configured.")
        
        if not items:
            raise ValueError("Items list cannot be empty.")

        cfg = self.dispatcher.configs[agent_name]
        job_id = str(uuid.uuid4())
        
        # Initialize Context with Deque for performance
        ctx = JobContext(
            job_id=job_id,
            agent_name=agent_name,
            items=deque(items), 
            params=params or {},
            callbacks=callbacks,
            batch_size=cfg.batch_size,
            url=cfg.request_url,
            timeout=cfg.timeout_sec
        )
        
        await self.dispatcher.submit(ctx)
        return job_id
