import uuid
import logging
from collections import deque
from .dispatcher import JobContext, Dispatcher

logger = logging.getLogger(__name__)

class JobRunner:
    def __init__(self, dispatcher: Dispatcher):
        self.dispatcher = dispatcher

    async def submit_job(self, agent_name: str, items: list, params: dict, callbacks: object) -> str:
        if agent_name not in self.dispatcher.configs:
            logger.error(f"Submit failed: Agent '{agent_name}' unknown")
            raise ValueError(f"Agent '{agent_name}' is not configured.")
        
        if not items:
            logger.error(f"Submit failed: Items list empty for agent '{agent_name}'")
            raise ValueError("Items list cannot be empty.")

        cfg = self.dispatcher.configs[agent_name]
        job_id = str(uuid.uuid4())
        
        logger.info(f"[{job_id}] Creating job for {agent_name} with {len(items)} items")

        ctx = JobContext(
            job_id=job_id,
            agent_name=agent_name,
            items=deque(items), 
            params=params or {},
            callbacks=callbacks,
            batch_size=cfg.batch_size,
            url=cfg.request_url,
            timeout=cfg.timeout_sec
        )
        
        await self.dispatcher.submit(ctx)
        return job_id
